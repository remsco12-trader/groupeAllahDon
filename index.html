<script>
    // Charger et traiter les données Google Sheets
    const sheetUrl = "https://docs.google.com/spreadsheets/d/1lQVgkO9AQ3l73MncVuSmIe4UO2LGAmWBXIAARTonQKY/gviz/tq?tqx=out:csv&sheet=liste";
    let allContacts = [];
    let filteredContacts = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    Papa.parse(sheetUrl, {
        download: true,
        header: true,
        complete: function (results) {
            allContacts = results.data;
            filteredContacts = allContacts;
            createFilters(allContacts);
            renderContacts();
        }
    });

    function createFilters(data) {
        const filters = [
            { id: "filter-formation", label: "Filtrer par formation", key: "Formation" },
            { id: "filter-daara", label: "Filtrer par daara", key: "Daara" },
            { id: "filter-quartier", label: "Filtrer par quartier", key: "Quartier" },
            { id: "filter-profession", label: "Filtrer par profession", key: "Profession" }
        ];

        const filterContainer = document.getElementById("filters");
        filters.forEach(filter => {
            const wrapper = document.createElement("div");
            const label = document.createElement("label");
            label.textContent = filter.label;

            const select = document.createElement("select");
            select.id = filter.id;
            select.innerHTML = '<option value="">Tous</option>';

            const uniqueValues = [...new Set(data.map(item => item[filter.key]).filter(Boolean))];
            uniqueValues.forEach(value => {
                const option = document.createElement("option");
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });

            select.addEventListener("change", applyFilters);

            wrapper.appendChild(label);
            wrapper.appendChild(select);
            filterContainer.appendChild(wrapper);
        });
    }

    function applyFilters() {
        const formation = document.getElementById("filter-formation").value;
        const daara = document.getElementById("filter-daara").value;
        const quartier = document.getElementById("filter-quartier").value;
        const profession = document.getElementById("filter-profession").value;
        const searchTerm = document.getElementById("search").value.toLowerCase();

        filteredContacts = allContacts.filter(contact => {
            return (!formation || contact.Formation === formation) &&
                   (!daara || contact.Daara === daara) &&
                   (!quartier || contact.Quartier === quartier) &&
                   (!profession || contact.Profession === profession) &&
                   (contact.Nom?.toLowerCase().includes(searchTerm) ||
                    contact["Prénom"]?.toLowerCase().includes(searchTerm) ||
                    contact.Profession?.toLowerCase().includes(searchTerm) ||
                    contact.Téléphone?.includes(searchTerm));
        });

        currentPage = 1;
        renderContacts();
    }

    function renderContacts() {
        const contactList = document.getElementById("contact-list");
        const resultCount = document.getElementById("result-count");
        const pagination = document.getElementById("pagination");
        contactList.innerHTML = "";
        pagination.innerHTML = "";

        const totalPages = Math.ceil(filteredContacts.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const contactsToShow = filteredContacts.slice(start, end);

        resultCount.textContent = `${filteredContacts.length} résultat(s)`;

        contactsToShow.forEach(contact => {
            const div = document.createElement("div");
            div.classList.add("contact-card");

            const name = contact.Nom || "";
            const firstName = contact["Prénom"] || "";
            const fullName = `${firstName} ${name}`.trim();

            div.innerHTML = `
                <h3>${fullName}</h3>
                <p><strong>Téléphone:</strong> <a href="tel:${contact.Téléphone}">${contact.Téléphone}</a></p>
                <p><strong>Profession:</strong> ${contact.Profession || "N/A"}</p>
                <p><strong>Quartier:</strong> ${contact.Quartier || "N/A"}</p>
                <p><strong>Formation:</strong> ${contact.Formation || "N/A"}</p>
                <p><strong>Daara:</strong> ${contact.Daara || "N/A"}</p>
            `;
            contactList.appendChild(div);
        });

        for (let i = 1; i <= totalPages; i++) {
            const button = document.createElement("button");
            button.textContent = i;
            if (i === currentPage) button.classList.add("active");
            button.addEventListener("click", () => {
                currentPage = i;
                renderContacts();
            });
            pagination.appendChild(button);
        }
    }

    document.getElementById("search").addEventListener("input", applyFilters);
</script>
